name: Generate Vejtemp KML

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4 # Opdateret til v4 for bedre token-håndtering

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # --- NYT TRIN: Installer systemafhængigheder for GeoPandas (Nødvendigt for IDW) ---
      - name: Install System Dependencies (GeoStack)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgdal-dev libgeos-dev libproj-dev
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt

      - name: Run vejtemp script
        run: |
          python fetch_temperatures.py
          python generate_interpolated_kml.py

      # --- OPPDATERET FIL-LISTE ---
      - name: Upload KML artifacts
        uses: actions/upload-artifact@v4
        with:
          name: vejtemp_kml_output
          path: |
            vejtemp_only.kml
            vejtemp_dugpunkt.kml
            vejtemp_map.png  # NYT: Detaljeret temperaturkort
            risk_map.png     # NYT: Detaljeret risikokort
      
      # --- OPPDATERET COMMIT TRIN ---
      - name: Commit and push kml files
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # Tilføj alle genererede filer
          git add vejtemp_only.kml vejtemp_dugpunkt.kml vejtemp_map.png risk_map.png
          git commit -m "Opdaterede KML/PNG via IDW [skip ci]" || echo "No changes to commit"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
